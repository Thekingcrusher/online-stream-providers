{
  "id":"kaa",
  "name":"KickAssAnime",
  "version":"1.0.4",
  "manifestURI":"https://raw.githubusercontent.com/Thekingcrusher/online-stream-providers/refs/heads/main/kaa/manifest.json",
  "language":"typescript",
  "type":"onlinestream-provider",
  "description":"KickAssAnime is an online stream provider for both sub and dub with soft subs.",
  "author":"Thekingcrusher",
  "icon":"https://raw.githubusercontent.com/Thekingcrusher/online-stream-providers/refs/heads/main/kaa/logo.ico",
  "lang":"en",
  "userConfig":{
    "version":1,
    "requiresConfig":false,
    "fields":[
      {
        "type":"select",
        "name":"domain",
        "label":"Domain Selection",
        "options":[
          {"value":"https://kaa.lt","label":"kaa.lt"},
          {"value":"https://kickassanime.cx","label":"kickass-anime.cx"}
        ],
        "default":"https://kaa.lt"}
    ]},
  "payload":"/// \u003creference path=\"./online-streaming-provider.d.ts\" /\u003e\n\nclass Provider {\n  base = \"{{domain}}\";\n\n  getSettings(): Settings {\n    return {\n      episodeServers: [\"VidStreaming\", \"CatStream\"],\n      supportsDub: true,\n    };\n  }\n\n  async search(query: SearchOptions): Promise\u003cSearchResult[]\u003e {\n    const res = await fetch(`${this.base}/api/fsearch`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        query: query.query,\n        page: 1,\n      }),\n    });\n  \n    const data = await res.json();\n  \n    if (!data.result || data.result.length === 0) {\n      throw new Error(\"ERROR: no anime found\");\n    }\n  \n    return data.result.map((item) =\u003e ({\n      id: `${item.slug}/${query.dub ? \"dub\" : \"sub\"}`,\n      title: item.title_en || item.title,\n      url: `https://kaa.to${item.watch_uri}`,\n      subOrDub: query.dub ? \"dub\" : \"sub\",\n    }));\n  }\n\n  async findEpisodes(id: string): Promise\u003cEpisode[]\u003e {\n    const [slug, type] = id.split(\"/\");\n\n    // Fetch available languages for the show\n    const langRes = await fetch(`${this.base}/api/show/${slug}/language`);\n    const langJson = await langRes.json();\n    const langData: string[] = langJson.result;\n  \n    // Determine language\n    let lang: string;\n    if (type === \"dub\") {\n      // Figure out what sub would have picked\n      const subLang =\n        langData.includes(\"zh-CN\")\n          ? \"zh-CN\"\n          : langData.includes(\"ja-JP\")\n            ? \"ja-JP\"\n            : langData[0];\n  \n      if (subLang === \"ja-JP\") {\n        // If sub is ja-JP, then prefer en-US for dub if possible\n        lang = langData.includes(\"en-US\") ? \"en-US\" : langData[0];\n      } else {\n        // Otherwise, prefer ja-JP for dub\n        lang = langData.includes(\"ja-JP\") ? \"ja-JP\" : langData[0];\n      }\n    } else {\n      // Sub logic: prefer zh-CN \u003e ja-JP \u003e first\n      lang =\n        langData.includes(\"zh-CN\")\n          ? \"zh-CN\"\n          : langData.includes(\"ja-JP\")\n            ? \"ja-JP\"\n            : langData[0];\n    }\n  \n    const baseUrl = `${this.base}/api/show/${slug}/episodes?ep=1\u0026lang=${lang}`;\n  \n    // Fetch first page\n    const firstRes = await fetch(`${baseUrl}\u0026page=1`);\n    const firstData = await firstRes.json();\n  \n    // Determine all pages to fetch\n    const pages = firstData.pages?.map((p: any) =\u003e p.number) || [1];\n  \n    // Fetch all other pages in parallel\n    const otherPagePromises = pages\n      .filter((p) =\u003e p !== 1)\n      .map((page) =\u003e fetch(`${baseUrl}\u0026page=${page}`).then((r) =\u003e r.json()));\n  \n    const otherPageData = await Promise.all(otherPagePromises);\n  \n    // Combine all results into one array\n    const allResults = [firstData, ...otherPageData]\n      .flatMap((pageData) =\u003e pageData.result)\n      .filter((ep: any) =\u003e Number.isInteger(ep.episode_number)); // Skip non-integer episodes\n  \n    return allResults.map((ep: any) =\u003e ({\n      id: ep.slug,\n      title: ep.title || `Episode ${ep.episode_string}`,\n      number: ep.episode_number,\n      url: `${this.base}/api/show/${slug}/episode/ep-${ep.episode_string}-${ep.slug}`,\n    }));\n  }\n\n  async findEpisodeServer(episode: EpisodeDetails, _server: string): Promise\u003cEpisodeServer\u003e {\n    const res = await fetch(episode.url);\n    const data = await res.json();\n  \n    const server = data.servers.find((s: any) =\u003e\n      s.name.toLowerCase().trim() === _server.toLowerCase().trim()\n    );\n    if (!server) {\n      console.warn(\"Available servers:\", data.servers.map((s: any) =\u003e s.name));\n      throw new Error(\"ERROR: server not found\");\n    }\n  \n    let videoUrl = server.src;\n    let subtitles: Subtitle[] = [];\n    const playerRes = await fetch(videoUrl);\n    const html = await playerRes.text();\n  \n    if (_server === \"Vidstreaming\" || \"CatStream\") {\n      const astroMatch = html.match(/\u003castro-island[^\u003e]+props=\"([^\"]+)\"[^\u003e]*\u003e/);\n      if (!astroMatch) throw new Error(\"Astro-island props not found in CatStream player\");\n  \n      const propsStr = astroMatch[1].replace(/\u0026quot;/g, '\"');\n      const props = JSON.parse(propsStr);\n  \n      if (props.manifest \u0026\u0026 props.manifest[1]) {\n        let manifestUrl = props.manifest[1];\n        if (manifestUrl.startsWith(\"//\")) {\n          manifestUrl = \"https:\" + manifestUrl;\n        } else if (!manifestUrl.startsWith(\"http\")) {\n          manifestUrl = \"https://\" + manifestUrl;\n        }\n        videoUrl = manifestUrl;\n      } else {\n        throw new Error(\"Manifest URL not found\");\n      }\n  \n      subtitles = (props.subtitles \u0026\u0026 props.subtitles[1]) ? props.subtitles[1].map((sub: any) =\u003e {\n        const urlRaw = sub[1].src[1];\n        const urlFixed = urlRaw.replace(\"https:///\", \"https://\");\n        const languageCode = sub[1].language[1];\n        const languageName = sub[1].name[1];\n  \n        return {\n          id: languageCode,\n          url: urlFixed,\n          language: languageName,\n          isDefault: languageCode === \"en\",\n        };\n      }) : [];\n    }\n  \n    return {\n      server: _server,\n      headers: {\n        \"Origin\": \"https://krussdomi.com\",\n        \"Referer\": server.src,\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Edg/139.0.0.0\",\n      },\n      videoSources: [\n        {\n          url: videoUrl,\n          quality: \"auto\",\n          type: \"m3u8\",\n          subtitles,\n        },\n      ],\n    };\n  }\n}"
}
